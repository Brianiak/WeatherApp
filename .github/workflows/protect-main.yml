name: Protect Main Branch

on:
  push:
    branches:
      - main

jobs:
  block-direct-push:
    name: Block direct push to main
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Check commit is linked to a pull request
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const commitSha = context.sha;

            const response = await github.request(
              "GET /repos/{owner}/{repo}/commits/{commit_sha}/pulls",
              {
                owner,
                repo,
                commit_sha: commitSha
              }
            );

            if (response.data.length === 0) {
              core.setFailed(
                `Direct push to main detected for commit ${commitSha}. Please use a pull request.`
              );
            } else {
              core.info(
                `Main update allowed: commit ${commitSha} is linked to PR #${response.data[0].number}.`
              );
            }
